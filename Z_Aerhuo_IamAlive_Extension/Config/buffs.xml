<config>
    <append xpath="/buffs">

        <!-- 玩家身上的追踪、计数、计时、增伤一体化Buff -->
        <buff name="buffMarkOfDeathTracker" name_key="buffMarkOfDeathTrackerName" description_key="buffMarkOfDeathTrackerDesc" icon="ui_game_symbol_skull" icon_color="0,255,0">
            <stack_type value="replace"/>
            <!-- 修改：持续时间变为3秒 -->
            <duration value="3"/>
            <display_value value="playerMarkCounter"/>
            <display_value_key value="buffMarkOfDeathTrackerValue"/>

            <!-- 步骤1: 通用的叠层逻辑 -->
            <effect_group>
                <!-- 修改：上限变为20层 -->
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerMarkCounter" operation="add" value="1">
                    <requirement name="CVarCompare" cvar="playerMarkCounter" operation="LT" value="20"/>
                </triggered_effect>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerMarkCounter" operation="add" value="1">
                    <requirement name="CVarCompare" cvar="playerMarkCounter" operation="LT" value="20"/>
                </triggered_effect>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerMarkCounter" operation="set" value="1">
                    <requirement name="CVarCompare" cvar="playerMarkCounter" operation="Equals" value="0"/>
                </triggered_effect>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerMarkCounter" operation="set" value="1">
                    <requirement name="CVarCompare" cvar="playerMarkCounter" operation="Equals" value="0"/>
                </triggered_effect>
                <triggered_effect trigger="onSelfBuffStart" action="RefreshBuffDisplay" buff="buffMarkOfDeathTracker"/>
                <triggered_effect trigger="onSelfBuffStack" action="RefreshBuffDisplay" buff="buffMarkOfDeathTracker"/>
            </effect_group>

            <!-- 步骤2: 根据技能等级，选择不同的伤害倍率进行计算 -->
            <!-- 等级1: 每层 1% -->
            <effect_group>
                <requirement name="ProgressionLevel" progression_name="perkMarkOfDeath" operation="Equals" value="1"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.01"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.01"/>
            </effect_group>
            <!-- 等级2: 每层 1.5% -->
            <effect_group>
                <requirement name="ProgressionLevel" progression_name="perkMarkOfDeath" operation="Equals" value="2"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.015"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.015"/>
            </effect_group>
            <!-- 等级3: 每层 2% -->
            <effect_group>
                <requirement name="ProgressionLevel" progression_name="perkMarkOfDeath" operation="Equals" value="3"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.02"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.02"/>
            </effect_group>
            <!-- 等级4: 每层 2.5% -->
            <effect_group>
                <requirement name="ProgressionLevel" progression_name="perkMarkOfDeath" operation="Equals" value="4"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.025"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.025"/>
            </effect_group>
            <!-- 等级5: 每层 3% -->
            <effect_group>
                <requirement name="ProgressionLevel" progression_name="perkMarkOfDeath" operation="Equals" value="5"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="set" value="@playerMarkCounter"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.03"/>
                <triggered_effect trigger="onSelfBuffStack" action="ModifyCVar" cvar="playerDamageBonus" operation="multiply" value="0.03"/>
            </effect_group>

            <!-- 步骤3: 通用的伤害加成应用和清理逻辑 -->
            <effect_group>
                <passive_effect name="DamageModifier" operation="perc_add" value="@playerDamageBonus"/>
                <triggered_effect trigger="onSelfBuffFinish" action="RemoveCVar" cvar="playerMarkCounter,playerDamageBonus"/>
            </effect_group>
        </buff>

        <!-- 破甲：敌人Debuff (共5级) -->
        <!-- 敌人Debuff (等级 1): 降低30%物理抗性。 -->
        <buff name="buffArmorShredded_L1" name_key="buffArmorShreddedName" description_key="buffArmorShreddedDesc_L1" icon="ui_game_symbol_armor_iron" icon_color="255,0,0">
            <stack_type value="replace"/>
            <duration value="0"/>
            <effect_group>
                <passive_effect name="PhysicalDamageResist" operation="perc_subtract" value=".30"/>
            </effect_group>
        </buff>

        <!-- 敌人Debuff (等级 2): 降低40%物理抗性。 -->
        <buff name="buffArmorShredded_L2" name_key="buffArmorShreddedName" description_key="buffArmorShreddedDesc_L2" icon="ui_game_symbol_armor_iron" icon_color="255,0,0">
            <stack_type value="replace"/>
            <duration value="0"/>
            <effect_group>
                <passive_effect name="PhysicalDamageResist" operation="perc_subtract" value=".40"/>
            </effect_group>
        </buff>

        <!-- 敌人Debuff (等级 3): 降低50%物理抗性。 -->
        <buff name="buffArmorShredded_L3" name_key="buffArmorShreddedName" description_key="buffArmorShreddedDesc_L3" icon="ui_game_symbol_armor_iron" icon_color="255,0,0">
            <stack_type value="replace"/>
            <duration value="0"/>
            <effect_group>
                <passive_effect name="PhysicalDamageResist" operation="perc_subtract" value=".50"/>
            </effect_group>
        </buff>

        <!-- 敌人Debuff (等级 4): 降低60%物理抗性。 -->
        <buff name="buffArmorShredded_L4" name_key="buffArmorShreddedName" description_key="buffArmorShreddedDesc_L4" icon="ui_game_symbol_armor_iron" icon_color="255,0,0">
            <stack_type value="replace"/>
            <duration value="0"/>
            <effect_group>
                <passive_effect name="PhysicalDamageResist" operation="perc_subtract" value=".60"/>
            </effect_group>
        </buff>

        <!-- 敌人Debuff (等级 5): 降低70%物理抗性。 -->
        <buff name="buffArmorShredded_L5" name_key="buffArmorShreddedName" description_key="buffArmorShreddedDesc_L5" icon="ui_game_symbol_armor_iron" icon_color="255,0,0">
            <stack_type value="replace"/>
            <duration value="0"/>
            <effect_group>
                <passive_effect name="PhysicalDamageResist" operation="perc_subtract" value=".70"/>
            </effect_group>
        </buff>

        <!-- 破甲：玩家Buff -->
        <buff name="buffArmorBreakerReady" name_key="buffArmorBreakerReadyName" description_key="buffArmorBreakerReadyDesc" icon="ui_game_symbol_destruction2" icon_color="0,255,0">
            <stack_type value="ignore"/>
            <duration value="0"/>
        </buff>

        <buff name="buffArmorBreakerCooldown" name_key="buffArmorBreakerCooldownName" description_key="buffArmorBreakerCooldownDesc" icon="ui_game_symbol_destruction2" icon_color="128,128,128">
            <stack_type value="replace"/>
            <duration value="0"/>
            <update_rate value="1"/>
            <display_value value=".cooldownDisplay"/>
            <display_value_format value="time"/>

            <effect_group>
                <!-- Buff开始时，将内部计时器设置为由Perk设定的冷却时间 -->
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".cooldownTimer" operation="set" value="@.armorBreakerCooldownTime"/>
                <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".cooldownDisplay" operation="set" value="@.armorBreakerCooldownTime"/>

                <!-- 每秒更新计时器 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".cooldownTimer" operation="subtract" value="1"/>
                <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".cooldownDisplay" operation="subtract" value="1"/>

                <!-- 计时结束后移除自身 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffArmorBreakerCooldown">
                    <requirement name="CVarCompare" cvar=".cooldownTimer" operation="LTE" value="0"/>
                </triggered_effect>

                <!-- 冷却结束后，给予准备就绪Buff -->
                <triggered_effect trigger="onSelfBuffFinish" action="AddBuff" buff="buffArmorBreakerReady"/>
                <triggered_effect trigger="onSelfBuffRemove" action="RemoveCVar" cvar=".cooldownTimer,.cooldownDisplay,.armorBreakerCooldownTime"/>
            </effect_group>
        </buff>

    </append>

    <!-- ==================================================================================== -->
    <!-- =================== 覆盖式修改 VFINAL：内置增益的平滑过渡 (简洁最终版) =================== -->
    <!-- ==================================================================================== -->

    <!-- 步骤 1: 移除原模组中定义的4个相关的Debuff -->
    <remove xpath="/buffs/buff[@name='buffProteinHigh']"/>
    <remove xpath="/buffs/buff[@name='buffProteinHigh01']"/>
    <remove xpath="/buffs/buff[@name='buffCarbonWaterHigh']"/>
    <remove xpath="/buffs/buff[@name='buffCarbonWaterHigh01']"/>

    <!-- 步骤 2: 重建我们修改后的新版本 -->
    <append xpath="/buffs">

        <!-- 新建: 蛋白质偏高 (450-500) - 内置LV4增益 -->
        <buff name="buffProteinHigh" name_key="蛋白质偏高" description_key="buffProteinHighDesc" tooltip_key="你蛋白质偏高，自身的消化能力有些许变化" icon="ui_game_symbol_Protein" icon_color="255,153,53">
            <stack_type value="replace"/>
            <update_rate value="2"/>
            <effect_group>
                <!-- 负面效果 -->
                <passive_effect name="WaterChangeOT" operation="perc_subtract" value=".1"/>
                <passive_effect name="FoodChangeOT" operation="perc_subtract" value=".1"/>
                <!-- 内置的LV4蛋白质增益 -->
                <passive_effect name="CarryCapacity" operation="base_add" value="8"/>
                <passive_effect name="HealthMax" operation="base_add" value="25"/>
                <passive_effect name="StaminaMax" operation="base_add" value="25"/>
                <!-- 移除条件 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffProteinHigh">
                    <requirement name="CVarCompare" target="self" cvar="whhzProtein" operation="LTE" value="450"/>
                </triggered_effect>
            </effect_group>
        </buff>

        <!-- 新建: 蛋白质过高 (500-550) - 内置LV2增益 -->
        <buff name="buffProteinHigh01" name_key="蛋白质过高" description_key="buffProteinHigh01Desc" tooltip_key="你蛋白质过高，自身的消化能力有些变化" icon="ui_game_symbol_Protein" icon_color="255,125,64">
            <stack_type value="replace"/>
            <update_rate value="2"/>
            <effect_group>
                <!-- 负面效果 -->
                <passive_effect name="WaterChangeOT" operation="perc_subtract" value=".35"/>
                <passive_effect name="FoodChangeOT" operation="perc_subtract" value=".35"/>
                <!-- 内置的LV2蛋白质增益 -->
                <passive_effect name="CarryCapacity" operation="base_add" value="4"/>
                <passive_effect name="HealthMax" operation="base_add" value="15"/>
                <passive_effect name="StaminaMax" operation="base_add" value="15"/>
                <!-- 移除条件 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffProteinHigh01">
                    <requirement name="CVarCompare" target="self" cvar="whhzProtein" operation="LTE" value="500"/>
                </triggered_effect>
            </effect_group>
        </buff>

        <!-- 新建: 轻度高血压 (450-500) - 内置LV4增益 -->
        <buff name="buffCarbonWaterHigh" name_key="轻度高血压" description_key="buffCarbonWaterHighDesc" tooltip_key="你的碳水化合物高了，造成了轻度高血压" icon="whhz_hypertension" icon_color="255,153,53">
            <stack_type value="replace"/>
            <update_rate value="2"/>
            <effect_group>
                <!-- 负面效果 -->
                <passive_effect name="StaminaMax" operation="base_add" value="-20"/>
                <passive_effect name="HealthMax" operation="base_add" value="-20"/>
                <!-- 内置的LV4碳水增益 -->
                <passive_effect name="EntityDamage" operation="perc_add" value=".2"/>
                <passive_effect name="AttacksPerMinute" operation="perc_add" value=".2"/>
                <passive_effect name="ReloadSpeedMultiplier" operation="perc_add" value=".2"/>
                <passive_effect name="RunSpeed" operation="perc_add" value=".2"/>
                <passive_effect name="WalkSpeed" operation="perc_add" value=".2"/>
                <!-- 移除条件 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffCarbonWaterHigh">
                    <requirement name="CVarCompare" target="self" cvar="whhzCarbonWater" operation="LTE" value="450"/>
                </triggered_effect>
            </effect_group>
        </buff>

        <!-- 新建: 中度高血压 (500-550) - 内置LV2增益 -->
        <buff name="buffCarbonWaterHigh01" name_key="中度高血压" description_key="buffCarbonWaterHigh01Desc" tooltip_key="你的碳水化合物高了，造成了高度高血压" icon="whhz_hypertension" icon_color="255,125,64">
            <stack_type value="replace"/>
            <update_rate value="2"/>
            <effect_group>
                <!-- 负面效果 -->
                <passive_effect name="StaminaMax" operation="base_add" value="-50"/>
                <passive_effect name="HealthMax" operation="base_add" value="-50"/>
                <!-- 内置的LV2碳水增益 -->
                <passive_effect name="EntityDamage" operation="perc_add" value=".1"/>
                <passive_effect name="AttacksPerMinute" operation="perc_add" value=".1"/>
                <passive_effect name="ReloadSpeedMultiplier" operation="perc_add" value=".1"/>
                <passive_effect name="RunSpeed" operation="perc_add" value=".1"/>
                <passive_effect name="WalkSpeed" operation="perc_add" value=".1"/>
                <!-- 移除条件 -->
                <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffCarbonWaterHigh01">
                    <requirement name="CVarCompare" target="self" cvar="whhzCarbonWater" operation="LTE" value="500"/>
                </triggered_effect>
            </effect_group>
        </buff>

    </append>

    <!-- ================================================================================== -->
    <!-- =================== 覆盖式修改 VFINAL：内置增益的平滑过渡 (简洁最终版) END =================== -->
    <!-- ================================================================================== -->

</config>